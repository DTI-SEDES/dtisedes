<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gerenciamento de Usuários SEDES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .user-table {
            font-size: 0.875rem;
        }
        .alert-attention {
            border-left: 4px solid #dc3545;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .stats-card {
            text-align: center;
            padding: 1rem;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.075);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Cabeçalho -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users me-2"></i>Dashboard de Gerenciamento de Usuários
                </h1>
                <p class="text-muted">SEDES - Comparação entre SOE Web e Office 365</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" id="exportBtn">
                    <i class="fas fa-download me-2"></i>Exportar Dados
                </button>
            </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number text-primary" id="totalUsers">0</div>
                        <div class="text-muted">Total de Usuários</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number text-success" id="bothSystems">0</div>
                        <div class="text-muted">Em Ambos os Sistemas</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number text-warning" id="onlySoe">0</div>
                        <div class="text-muted">Apenas no SOE Web</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-number text-info" id="onlyOffice">0</div>
                        <div class="text-muted">Apenas no Office 365</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Pesquisar</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Nome, email, matrícula...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Setor</label>
                    <select class="form-select" id="setorFilter">
                        <option value="">Todos os Setores</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">Todos</option>
                        <option value="both">Em Ambos</option>
                        <option value="soe_only">Apenas SOE</option>
                        <option value="office_only">Apenas Office 365</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Licença</label>
                    <select class="form-select" id="licenseFilter">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Alertas de Atenção -->
        <div class="row mb-4" id="attentionAlerts" style="display: none;">
            <div class="col-12">
                <div class="alert alert-warning alert-attention">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Atenção</h6>
                    <div id="attentionContent"></div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Distribuição por Status</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Licenças Office 365</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="licenseChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Usuários -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Lista de Usuários</h6>
                <span class="badge bg-secondary" id="userCount">0 usuários</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover user-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Matrícula</th>
                                <th>Setor</th>
                                <th>SOE Web</th>
                                <th>Office 365</th>
                                <th>Licença</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Dados serão preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados do SOE Web (baseado no arquivo enviado)
        const soeUsers = [
            {
                nome: "Andrea Corneli Ortis",
                organizacao: "SEDES",
                setor: "ASSCOM",
                matricula: "4821254",
                prazoOperacao: "14/03/2033",
                ultimaSessao: "10/09/2025 09:08:02",
                bloqueado: "",
                email: "andrea-ortis@social.rs.gov.br;ortis.andrea@gmail.com",
                cpf: "02214137076",
                codigoInterno: "664075"
            },
            {
                nome: "Brayan Martins Viana",
                organizacao: "SEDES",
                setor: "ASSCOM",
                matricula: "5079756",
                prazoOperacao: "02/07/2033",
                ultimaSessao: "14/07/2025 13:58:39",
                bloqueado: "",
                email: "brayan-viana@social.rs.gov.br",
                cpf: "02429017008",
                codigoInterno: "978349"
            },
            {
                nome: "Camila Leite Martins",
                organizacao: "SEDES",
                setor: "ASSCOM",
                matricula: "4674111",
                prazoOperacao: "14/03/2033",
                ultimaSessao: "08/09/2025 16:19:07",
                bloqueado: "",
                email: "camila-martins@social.rs.gov.br",
                cpf: "01779538022",
                codigoInterno: "869702"
            },
            // Adicione mais usuários conforme necessário do arquivo SOE
        ];

        // Dados do Office 365 (baseado no arquivo enviado)
        const office365Users = [
            {
                conta: "adriana-oliveira@social.rs.gov.br",
                nome: "Adriana Aparecida de Oliveira",
                matricula: "3948544",
                setor: "DAS",
                licencaMPSA: "Office 365 E3",
                O365Sku: "ENTERPRISEPACK",
                tipo_conta: "Usuario"
            },
            {
                conta: "albano-kunrath@social.rs.gov.br",
                nome: "Albano José Kunrath",
                matricula: "31778291015",
                setor: "DIPPE",
                licencaMPSA: "Office 365 E1",
                O365Sku: "STANDARDPACK",
                tipo_conta: "Usuario"
            },
            {
                conta: "alessandra-almeida@social.rs.gov.br",
                nome: "Alessandra Gois de Almeida",
                matricula: "444832401",
                setor: "DAS",
                licencaMPSA: "Office 365 E3",
                O365Sku: "ENTERPRISEPACK",
                tipo_conta: "Usuario"
            },
            // Adicione mais usuários conforme necessário do arquivo Office 365
        ];

        // Função para extrair email principal
        function extractPrimaryEmail(emailString) {
            if (!emailString) return '';
            // Pega o primeiro email se houver múltiplos separados por ;
            return emailString.split(';')[0].trim().toLowerCase();
        }

        // Função para normalizar matrícula
        function normalizeMatricula(matricula) {
            if (!matricula) return '';
            return matricula.toString().replace(/\D/g, '');
        }

        // Função para processar os dados
        function processData() {
            const allUsers = [];
            const userMap = new Map();

            // Processar usuários do SOE Web
            soeUsers.forEach(user => {
                const primaryEmail = extractPrimaryEmail(user.email);
                const normalizedMatricula = normalizeMatricula(user.matricula);
                
                const key = primaryEmail || user.nome?.toLowerCase() || normalizedMatricula;
                
                if (key) {
                    userMap.set(key, {
                        nome: user.nome,
                        email: primaryEmail,
                        matricula: normalizedMatricula,
                        setor: user.setor,
                        soeWeb: true,
                        prazoOperacao: user.prazoOperacao,
                        ultimaSessao: user.ultimaSessao,
                        bloqueado: user.bloqueado,
                        cpf: user.cpf,
                        codigoInterno: user.codigoInterno,
                        organizacao: user.organizacao
                    });
                }
            });

            // Processar usuários do Office 365
            office365Users.forEach(user => {
                const primaryEmail = extractPrimaryEmail(user.conta);
                const normalizedMatricula = normalizeMatricula(user.matricula);
                
                const key = primaryEmail || user.nome?.toLowerCase() || normalizedMatricula;
                
                if (key) {
                    const existingUser = userMap.get(key) || {};
                    userMap.set(key, {
                        ...existingUser,
                        nome: existingUser.nome || user.nome,
                        email: existingUser.email || primaryEmail,
                        matricula: existingUser.matricula || normalizedMatricula,
                        setor: existingUser.setor || user.setor,
                        office365: true,
                        licenca: user.licencaMPSA,
                        tipoConta: user.tipo_conta,
                        cargo: user.cargo,
                        O365Sku: user.O365Sku
                    });
                }
            });

            // Converter Map para array
            userMap.forEach(user => {
                allUsers.push(user);
            });

            return allUsers;
        }

        // Função para atualizar estatísticas
        function updateStats(users) {
            const total = users.length;
            const both = users.filter(u => u.soeWeb && u.office365).length;
            const onlySoe = users.filter(u => u.soeWeb && !u.office365).length;
            const onlyOffice = users.filter(u => !u.soeWeb && u.office365).length;

            document.getElementById('totalUsers').textContent = total;
            document.getElementById('bothSystems').textContent = both;
            document.getElementById('onlySoe').textContent = onlySoe;
            document.getElementById('onlyOffice').textContent = onlyOffice;
            document.getElementById('userCount').textContent = `${total} usuários`;

            // Atualizar gráficos
            updateCharts(both, onlySoe, onlyOffice, users);
        }

        // Função para atualizar gráficos
        function updateCharts(both, onlySoe, onlyOffice, users) {
            // Gráfico de status
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }
            window.statusChartInstance = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Em Ambos', 'Apenas SOE', 'Apenas Office 365'],
                    datasets: [{
                        data: [both, onlySoe, onlyOffice],
                        backgroundColor: ['#28a745', '#ffc107', '#17a2b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Gráfico de licenças
            const licenseCounts = {};
            users.forEach(user => {
                if (user.licenca) {
                    licenseCounts[user.licenca] = (licenseCounts[user.licenca] || 0) + 1;
                }
            });

            const licenseCtx = document.getElementById('licenseChart').getContext('2d');
            if (window.licenseChartInstance) {
                window.licenseChartInstance.destroy();
            }
            window.licenseChartInstance = new Chart(licenseCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(licenseCounts),
                    datasets: [{
                        label: 'Quantidade',
                        data: Object.values(licenseCounts),
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Função para renderizar tabela
        function renderTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                
                // Determinar status e classe
                let status = '';
                let statusClass = '';
                if (user.soeWeb && user.office365) {
                    status = 'Em Ambos';
                    statusClass = 'success';
                } else if (user.soeWeb) {
                    status = 'Apenas SOE';
                    statusClass = 'warning';
                } else if (user.office365) {
                    status = 'Apenas Office';
                    statusClass = 'info';
                }

                row.innerHTML = `
                    <td>${user.nome || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.matricula || 'N/A'}</td>
                    <td>${user.setor || 'N/A'}</td>
                    <td>
                        <span class="badge bg-${user.soeWeb ? 'success' : 'secondary'}">
                            ${user.soeWeb ? '✓' : '✗'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${user.office365 ? 'success' : 'secondary'}">
                            ${user.office365 ? '✓' : '✗'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">
                            ${user.licenca || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${statusClass}">${status}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Função para atualizar filtros
        function updateFilters(users) {
            const setores = new Set();
            const licencas = new Set();

            users.forEach(user => {
                if (user.setor) setores.add(user.setor);
                if (user.licenca) licencas.add(user.licenca);
            });

            // Atualizar filtro de setores
            const setorFilter = document.getElementById('setorFilter');
            setores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = setor;
                setorFilter.appendChild(option);
            });

            // Atualizar filtro de licenças
            const licenseFilter = document.getElementById('licenseFilter');
            licencas.forEach(licenca => {
                const option = document.createElement('option');
                option.value = licenca;
                option.textContent = licenca;
                licenseFilter.appendChild(option);
            });
        }

        // Função para aplicar filtros
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const setorFilter = document.getElementById('setorFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const licenseFilter = document.getElementById('licenseFilter').value;

            const filteredUsers = window.allUsers.filter(user => {
                // Filtro de pesquisa
                const matchesSearch = !searchTerm || 
                    (user.nome && user.nome.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.matricula && user.matricula.includes(searchTerm));

                // Filtro de setor
                const matchesSetor = !setorFilter || user.setor === setorFilter;

                // Filtro de status
                let matchesStatus = true;
                if (statusFilter === 'both') {
                    matchesStatus = user.soeWeb && user.office365;
                } else if (statusFilter === 'soe_only') {
                    matchesStatus = user.soeWeb && !user.office365;
                } else if (statusFilter === 'office_only') {
                    matchesStatus = !user.soeWeb && user.office365;
                }

                // Filtro de licença
                const matchesLicense = !licenseFilter || user.licenca === licenseFilter;

                return matchesSearch && matchesSetor && matchesStatus && matchesLicense;
            });

            renderTable(filteredUsers);
            updateStats(filteredUsers);
        }

        // Função para exportar dados
        document.getElementById('exportBtn').addEventListener('click', function() {
            const users = window.allUsers || [];
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nome,Email,Matrícula,Setor,SOE Web,Office 365,Licença,Status\n";

            users.forEach(user => {
                const status = user.soeWeb && user.office365 ? 'Em Ambos' : 
                             user.soeWeb ? 'Apenas SOE' : 
                             user.office365 ? 'Apenas Office 365' : 'N/A';
                
                const row = [
                    `"${user.nome || ''}"`,
                    `"${user.email || ''}"`,
                    `"${user.matricula || ''}"`,
                    `"${user.setor || ''}"`,
                    user.soeWeb ? 'Sim' : 'Não',
                    user.office365 ? 'Sim' : 'Não',
                    `"${user.licenca || ''}"`,
                    `"${status}"`
                ].join(',');
                
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "usuarios_sedes.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Função para atualizar alertas de atenção
        function updateAttentionAlerts(users) {
            const onlySoeUsers = users.filter(u => u.soeWeb && !u.office365);
            const onlyOfficeUsers = users.filter(u => !u.soeWeb && u.office365);
            
            if (onlySoeUsers.length > 0 || onlyOfficeUsers.length > 0) {
                let alertContent = '';
                
                if (onlySoeUsers.length > 0) {
                    alertContent += `<strong>${onlySoeUsers.length} usuários</strong> estão apenas no SOE Web e não no Office 365.<br>`;
                }
                
                if (onlyOfficeUsers.length > 0) {
                    alertContent += `<strong>${onlyOfficeUsers.length} usuários</strong> estão apenas no Office 365 e não no SOE Web.`;
                }
                
                document.getElementById('attentionContent').innerHTML = alertContent;
                document.getElementById('attentionAlerts').style.display = 'block';
            } else {
                document.getElementById('attentionAlerts').style.display = 'none';
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Processar dados
            window.allUsers = processData();
            
            // Atualizar interface
            updateStats(window.allUsers);
            renderTable(window.allUsers);
            updateFilters(window.allUsers);
            updateAttentionAlerts(window.allUsers);
            
            // Event listeners para filtros
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('setorFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('licenseFilter').addEventListener('change', applyFilters);
        });
    </script>
</body>
</html>
